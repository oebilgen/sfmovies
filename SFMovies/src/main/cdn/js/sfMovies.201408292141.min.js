function setMovieId(e){if(e==null||e.trim()==""){lastType="all";lastQuery=""}else{lastType="movieId";lastQuery=e}}function initializeMap(){map=new google.maps.Map(document.getElementById("map"),{zoom:defaultZoom,center:defaultCenter,mapTypeId:google.maps.MapTypeId.ROADMAP});google.maps.event.addListener(map,"bounds_changed",function(){if(boundsChangeExpected){console.debug("Bounds change is expected, skipping event...");return}console.info("Map reload is requested.");reloadRequested=true});google.maps.event.addListener(map,"idle",function(){if(lastQuery!=""){console.info("Last query is not empty ["+lastQuery+"], skipping map draw...");return}if(boundsChangeExpected){console.info("Bounds change is expected, skipping map draw...");boundsChangeExpected=false;return}if(reloadRequested){showMarkers(lastType,lastQuery)}reloadRequested=false});google.maps.event.addListener(map,"click",function(e){infoWindow.close()});overlappingMarkerSpiderfier=new OverlappingMarkerSpiderfier(map,{markersWontMove:true,markersWontHide:true,legWeight:1});overlappingMarkerSpiderfier.addListener("click",function(e){boundsChangeExpected=true;var t=movieSummarys[e.movieId].id;if(t in infoWindowContents){infoWindow.setContent(infoWindowContents[t]);infoWindow.open(map,e);return}var n=endpointPrefix+"movieDetail/"+t;$.ajax({type:"GET",dataType:"json",url:n,success:function(n){if(n==null){alert("Movie ID=["+t+"] not found.");return}boundsChangeExpected=true;infoWindow.setContent(createInfoWindowContent(n));infoWindow.open(map,e)},error:function(e,t,n){handleAjaxError(e,t,n)}})});overlappingMarkerSpiderfier.addListener("spiderfy",function(e){boundsChangeExpected=true;for(var t=0;t<e.length;t++){e[t].setIcon(spiderfiedIcon)}infoWindow.close()});overlappingMarkerSpiderfier.addListener("unspiderfy",function(e){boundsChangeExpected=true;for(var t=0;t<e.length;t++){e[t].setIcon(usualIcon)}})}function getMapBounds(){var e=map.getBounds();var t=e.getSouthWest();var n=e.getNorthEast();var r="swc="+t.lat()+","+t.lng();r+="&nec="+n.lat()+","+n.lng();return r}function showMarkers(e,t){console.info("Call: showMarkers("+e+","+t+")");var n=getMapBounds();if(lastType==e&&lastQuery==t&&lastMapBounds==n){console.info("Nothing changed, skipping showMarkers...");return}lastType=e;lastQuery=t;if(markerCluster!=null){markerCluster.clearMarkers()}if(overlappingMarkerSpiderfier!=null){overlappingMarkerSpiderfier.clearMarkers()}var r=endpointPrefix+e;if(t!=""){r+="/"+t;$("#query").val(decodeURIComponent(t))}if(e=="all"){r+="?"+n}console.info("Ajax URL: "+r);$.ajax({type:"GET",dataType:"json",url:r,success:function(t){if(t.success){movieSummarys=t.data;if(movieSummarys.length==0){if(e!="all"){alert("No results.")}return}console.log(movieSummarys.length+" result(s).");var n=new google.maps.LatLngBounds;var r=[];var i;for(i=0;i<movieSummarys.length;i++){var s=movieSummarys[i];if(e=="movieId"){$("#query").val(s.title)}var o=s.movieLocations;if(o==null||o.length==0){console.info('The movie "'+s.title+'" does not have a known address, skipping...');continue}for(var u=0;u<o.length;u++){movieLocation=o[u];if(movieLocation==null){console.error("DATA ERROR: title:"+s.title+" movieLocation:%o",movieLocation);continue}var a=new google.maps.LatLng(movieLocation.latitude,movieLocation.longitude);n.extend(a);var f=new google.maps.Marker({position:a,title:s.title,icon:usualIcon,movieId:i,locationId:u});overlappingMarkerSpiderfier.addMarker(f);r.push(f);console.log(s.title+" marker at "+a)}}markerCluster=new MarkerClusterer(map,r);markerCluster.setMaxZoom(14);if(e!="all"){boundsChangeExpected=true;map.fitBounds(n);lastMapBounds=n}if(i==0&&e=="movieId"){$("#query").val("")}}else{console.error("Failed to retrieve the results: "+JSON.stringify(t.errorMessage))}},error:function(e,t,n){handleAjaxError(e,t,n)}})}function handleAjaxError(e,t,n){alert("Error occured: "+JSON.stringify(t));console.log("textStatus: "+t);console.log("errorThrown: "+n);console.log("jqXHR"+e)}function createInfoWindowContent(e){var t=e.movieSummary;if(t.id in infoWindowContents){return infoWindowContents[t.id]}var n=t.title;var r=t.movieLocations;var i='<div class="infoWindow"><span class="movieTitle">'+n+' (<a href="#" class="infoWindowLink" onclick="showMarkers(\'releaseYear\', \''+encodeURIComponent(e.releaseYear)+"')\">"+e.releaseYear+"</a>)</span><br>";i+='Director: <a href="#" class="infoWindowLink" onclick="showMarkers(\'director\', \''+encodeURIComponent(e.director)+"')\">"+e.director+"</a><br>";var s=[];var o="";for(var u=0;u<e.actors.length;u++){s.push('<a href="#" class="infoWindowLink" onclick="showMarkers(\'actor\', \''+encodeURIComponent(e.actors[u])+"')\">"+e.actors[u]+"</a>");o+=" #"+e.actors[u].replace(" ","")}i+="Actors: "+s.join(", ")+"<br>";i+='Production Company: <a href="#" class="infoWindowLink" onclick="showMarkers(\'productionCompany\', \''+encodeURIComponent(e.productionCompany)+"')\">"+e.productionCompany+"</a><br>";i+='Distributor: <a href="#" class="infoWindowLink" onclick="showMarkers(\'distributor\', \''+encodeURIComponent(e.distributor)+"')\">"+e.distributor+"</a><br>";i+='Writer: <a href="#" class="infoWindowLink" onclick="showMarkers(\'writer\', \''+encodeURIComponent(e.writer)+"')\">"+e.writer+"</a><br>";i+="Addresses:<br>";for(var u=0;u<r.length;u++){var a=r[u];i+='<li><a href="https://www.google.com/maps/?q='+encodeURIComponent(a.formattedAddress)+'" class="infoWindowLink" target="_blank">'+a.formattedAddress+"</a>";if(a.funFacts!=null){i+='<br><span class="funFacts">'+a.funFacts+"</span>"}i+="</li>"}i+='<div class="shareButtons"><input type="button" onclick="window.open(\'http://google.com/search?q='+encodeURIComponent(n+" "+e.releaseYear+" movie watch online")+'\');" value="Watch online"> ';i+='<input type="button" onclick="window.open(\'http://www.amazon.com/s/ref=nb_sb_noss_1?field-keywords='+encodeURIComponent(n+" "+e.releaseYear)+' movie\');" value="Buy on Amazon"> ';i+='<input type="button" onclick="window.open(\'http://google.com/search?q='+encodeURIComponent(n+" "+e.releaseYear+" movie wikipedia")+'&btnI\');" value="Wikipedia"> ';i+='<input type="button" onclick="window.open(\'/?movieId='+t.id+'\');" value="Link"> ';i+='<input type="button" onclick="window.open(\'http://twitter.com/share?url=http://www.sfmovies.org/?movieId='+t.id+"&text="+n+encodeURIComponent(" #sanfrancisco #movie"+o)+"&via=oebilgen&related=uber', '', 'width=575, height=230');\" value=\"Tweet\"> ";i+="</div></div>";infoWindowContents[t.id]=i;return i}function getQueryString(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),n=t.exec(location.search);return n==null?"":decodeURIComponent(n[1].replace(/\+/g," "))}function toggleFullScreen(){if(isFullScreen){boundsChangeExpected=true;$("#fullScreenButton").prop("value","Full screen");$("#fullScreenButton").animate({margin:"58px 72px auto auto"});$("#header").animate({width:"90%",margin:"50px auto 0px auto"});$("#map").animate({width:"90%",height:"450px"})}else{boundsChangeExpected=false;reloadRequested=true;$("#fullScreenButton").prop("value","Theatre view");$("#fullScreenButton").animate({margin:"8px 0px auto auto"});$("#header").animate({width:"100%",margin:"0px auto 0px auto"});$("#map").animate({width:"100%",height:"100%"});map.setCenter(map.getCenter())}setTimeout(function(){google.maps.event.trigger(map,"resize")},500);isFullScreen=!isFullScreen}function printStackTrace(){var e=new Error("dummy");var t=e.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@").split("\n");console.error(t)}var defaultCenter=new google.maps.LatLng(37.7954783,-122.4052922);var defaultZoom=15;var endpointPrefix="/v1/movies/";var map=null;var movieSummarys=null;var overlappingMarkerSpiderfier=null;var infoWindow=new google.maps.InfoWindow({});var infoWindowContents={};var markerCluster=null;var usualIcon="http://cdn.sfmovies.org/images/usualIcon.201408270533.png";var spiderfiedIcon="http://cdn.sfmovies.org/images/spiderfiedIcon.201408270533.png";var isFullScreen=false;var boundsChangeExpected=false;var reloadRequested=false;var lastType="all";var lastQuery="";var lastMapBounds=null;$(document).ready(function(){var e,t;e={serviceUrl:endpointPrefix+"search",showNoSuggestionNotice:true,maxHeight:"60%",minChars:3,onSelect:function(e,t){var n="";switch(e.data){case"ACTOR":n="actor";break;case"DIRECTOR":n="director";break;case"DISTRIBUTOR":n="distributor";break;case"PRODUCTION_COMPANY":n="productionCompany";break;case"RELEASE_YEAR":n="releaseYear";break;case"TITLE":n="title";break;case"WRITER":n="writer";break;default:alert("Unknown search result: "+t);return}showMarkers(n,e.value)},formatResult:function(e,t,n){var r="";switch(e.data){case"ACTOR":r="actor";break;case"DIRECTOR":r="director";break;case"DISTRIBUTOR":r="distributor";break;case"PRODUCTION_COMPANY":r="production company";break;case"RELEASE_YEAR":r="release year";break;case"TITLE":r="title";break;case"WRITER":r="writer";break;default:alert("Unknown search result: "+e.data);return}return e.value.replace(t,"<strong>"+t+"</strong>")+' <span class="searchDescription"><font color="silver">'+r+"</font></span>"}};t=$("#query").autocomplete(e);$("#query").keyup(function(e){if($(this).val().length==0){lastType="all";lastQuery="";showMarkers(lastType,lastQuery)}})});(function(e,t,n,r,i,s,o){e["GoogleAnalyticsObject"]=i;e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date;s=t.createElement(n),o=t.getElementsByTagName(n)[0];s.async=1;s.src=r;o.parentNode.insertBefore(s,o)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-41345435-2","auto");ga("send","pageview");google.maps.event.addDomListener(window,"load",initializeMap)